<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth2 ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .spreadsheet-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .spreadsheet-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .spreadsheet-id {
            font-family: monospace;
            color: #666;
            font-size: 12px;
        }
        .spreadsheet-info {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”— Google OAuth2 ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™ í…ŒìŠ¤íŠ¸</h1>
    
    <div id="status">
        <p>ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸ ì¤‘...</p>
    </div>

    <div id="controls">
        <button onclick="checkAuthStatus()">ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸</button>
        <button onclick="authenticateGoogle()">ğŸ”‘ Google ë¡œê·¸ì¸</button>
        <button onclick="loadSpreadsheets()">ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ</button>
        <button onclick="searchSpreadsheets()">ğŸ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê²€ìƒ‰</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì´ˆê¸°í™”</button>
    </div>

    <div id="log"></div>

    <script>
        const API_BASE = 'http://localhost:5000';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    credentials: 'include',
                    headers: {
                        'Origin': 'http://localhost:3000',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                log(`API í˜¸ì¶œ ì‹¤íŒ¨ (${endpoint}): ${error.message}`, 'error');
                throw error;
            }
        }

        async function checkAuthStatus() {
            try {
                log('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
                const data = await apiCall('/api/admin/auth-status');
                
                const statusDiv = document.getElementById('status');
                if (data.authenticated) {
                    statusDiv.innerHTML = '<p class="success">âœ… Google ì¸ì¦ë¨</p>';
                    log('Google ì¸ì¦ ìƒíƒœ: ì¸ì¦ë¨ âœ…', 'success');
                } else {
                    statusDiv.innerHTML = '<p class="error">âŒ Google ì¸ì¦ í•„ìš”</p>';
                    log('Google ì¸ì¦ ìƒíƒœ: ì¸ì¦ í•„ìš” âŒ', 'error');
                }
                
                log(`ì„¸ì…˜ ID: ${data.sessionId}`, 'info');
            } catch (error) {
                log(`ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function authenticateGoogle() {
            try {
                log('Google ì¸ì¦ URL ìš”ì²­ ì¤‘...', 'info');
                const data = await apiCall('/api/admin/google-auth-url');
                
                log('Google ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'info');
                log(`ì¸ì¦ URL: ${data.authUrl}`, 'info');
                
                // ìƒˆ ì°½ì—ì„œ ì¸ì¦ ì§„í–‰
                window.open(data.authUrl, 'googleAuth', 'width=500,height=600');
                
                // 5ì´ˆ í›„ ì¸ì¦ ìƒíƒœ ì¬í™•ì¸
                setTimeout(() => {
                    log('5ì´ˆ í›„ ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤...', 'info');
                    checkAuthStatus();
                }, 5000);
                
            } catch (error) {
                log(`Google ì¸ì¦ URL ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        async function loadSpreadsheets() {
            try {
                log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ ì¤‘...', 'info');
                const data = await apiCall('/api/admin/spreadsheets?pageSize=10');
                
                if (data.success && data.data) {
                    log(`ğŸ“Š ì´ ${data.data.totalCount}ê°œì˜ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
                    
                    const spreadsheets = data.data.files || [];
                    if (spreadsheets.length > 0) {
                        let html = '<h3>ğŸ“‹ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡</h3>';
                        
                        spreadsheets.forEach(sheet => {
                            html += `
                                <div class="spreadsheet-item">
                                    <div class="spreadsheet-name">${sheet.name}</div>
                                    <div class="spreadsheet-id">ID: ${sheet.id}</div>
                                    <div class="spreadsheet-info">
                                        ìˆ˜ì •ì¼: ${new Date(sheet.modifiedTime).toLocaleString('ko-KR')} | 
                                        ì†Œìœ ì: ${sheet.owners ? sheet.owners.join(', ') : 'N/A'}
                                        ${sheet.starred ? ' â­' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('log').innerHTML += html;
                        
                        // JSON ì‘ë‹µë„ í‘œì‹œ
                        log('ì „ì²´ ì‘ë‹µ:', 'info');
                        document.getElementById('log').innerHTML += 
                            `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    }
                } else {
                    log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
                
            } catch (error) {
                if (error.message.includes('401') || error.message.includes('ì¸ì¦')) {
                    log('âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. Google ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    log(`ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        async function searchSpreadsheets() {
            const query = prompt('ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'ë°°ì†¡');
            if (!query) return;
            
            try {
                log(`"${query}" í‚¤ì›Œë“œë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê²€ìƒ‰ ì¤‘...`, 'info');
                const data = await apiCall(`/api/admin/spreadsheets?query=${encodeURIComponent(query)}&pageSize=5`);
                
                if (data.success && data.data) {
                    log(`ğŸ” "${query}" ê²€ìƒ‰ ê²°ê³¼: ${data.data.totalCount}ê°œ ë°œê²¬`, 'success');
                    
                    const spreadsheets = data.data.files || [];
                    if (spreadsheets.length > 0) {
                        let html = `<h3>ğŸ” "${query}" ê²€ìƒ‰ ê²°ê³¼</h3>`;
                        
                        spreadsheets.forEach(sheet => {
                            html += `
                                <div class="spreadsheet-item">
                                    <div class="spreadsheet-name">${sheet.name}</div>
                                    <div class="spreadsheet-id">ID: ${sheet.id}</div>
                                    <div class="spreadsheet-info">
                                        ìˆ˜ì •ì¼: ${new Date(sheet.modifiedTime).toLocaleString('ko-KR')}
                                        ${sheet.starred ? ' â­' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('log').innerHTML += html;
                    }
                }
                
            } catch (error) {
                log(`ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkAuthStatus();
        };
        
        // ì¸ì¦ ì™„ë£Œ í›„ ì½œë°± ì²˜ë¦¬
        window.addEventListener('message', function(event) {
            if (event.origin !== API_BASE) return;
            
            if (event.data.type === 'oauth_success') {
                log('âœ… Google ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                checkAuthStatus();
            } else if (event.data.type === 'oauth_error') {
                log(`âŒ Google ì¸ì¦ ì‹¤íŒ¨: ${event.data.error}`, 'error');
            }
        });
    </script>
</body>
</html>