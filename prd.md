# 구글 스프레드시트 기반 배송 관리 시스템 (MVP) - Product Requirements Document

## 개요
구글 스프레드시트에 저장된 주문 정보를 관리자가 직접 관리하고, 배송담당자는 QR 코드와 본인 인증을 통해 자신의 배송 목록에 접근할 수 있는 간소화된 MVP 시스템입니다. 배송 완료시에만 고객에게 카카오톡 메시지를 자동 발송합니다.

## 제품 목표 (MVP)
- 구글 스프레드시트를 메인 데이터 저장소로 활용
- QR 코드 + 이름 확인을 통한 간단한 배송담당자 인증
- 배송 완료시에만 고객 알림으로 스팸 메시지 방지
- Node.js + Vue.js 기반의 확장 가능한 웹 애플리케이션

## 핵심 기능 요구사항 (MVP)

### 1. 구글 스프레드시트 연동 관리 UI
- **스프레드시트 연결 인터페이스**:
  - 관리자용 설정 페이지에서 "구글 스프레드시트 연결하기" 버튼
  - Google OAuth2 인증을 통한 사용자 친화적 연동
  - 스프레드시트 URL 입력 또는 Google Drive에서 선택
- **연동 상태 확인**:
  - 현재 연결된 스프레드시트 정보 표시
  - 실시간 연결 상태 (연결됨/연결 끊김) 표시
  - "연결 해제" 및 "다른 시트 연결" 옵션 제공

### 2. 구글 스프레드시트 직접 관리 (날짜별 시트)
- **스프레드시트 구조**: 
  - **날짜별로 개별 스프레드시트** 생성 (YYYYMMDD 형식)
  - 스프레드시트명 = 날짜 (예: "20250825", "20250826", "20250827")
  - 각 스프레드시트 내에서 첫 번째 시트 사용
- **시트 내 데이터 구조**: 
  ```
  배송지 | 고객명 | 고객 연락처 | 배송 담당자 | 배송상태
  ```
- **배송 상태 값**: 5단계 시스템
  - "주문 완료" (초기값)
  - "상품 준비중" 
  - "배송 준비중"
  - "배송 출발"
  - "배송 완료"
- **관리자 작업**: 
  - 날짜별 스프레드시트에 주문 정보 직접 입력
  - 배송상태는 시스템에서 자동 관리 ("주문 완료"로 초기값 설정)
  - 동적 헤더 시스템으로 컬럼명 유연하게 대응
- **실시간 동기화**: Google Sheets API로 모든 시트 변경사항 실시간 감지

### 3. 배송담당자 웹사이트 (날짜별 접근 + 본인 인증)
- **QR 코드 접근**: 
  - 배송담당자별 고유 QR코드 (JWT 토큰 기반)
  - QR 코드 형식: `/delivery/:date/:staffName?token=JWT_TOKEN`
  - 24시간 만료 JWT 토큰으로 보안 강화
- **본인 인증 절차**:
  - QR 스캔 후 "본인 이름을 입력하세요" 화면 표시
  - 입력한 이름과 URL의 staffName 파라미터 일치 검증
  - 불일치 시 "이름이 일치하지 않습니다. 다시 확인해주세요." 오류 표시
- **배송 목록 조회**: 
  - 인증 완료 후 해당 날짜의 배송담당자 주문 목록 표시
  - 각 주문별로 독립적인 상태 관리
  - 동적 헤더 시스템으로 다양한 데이터 구조 지원
- **배송 상태 업데이트**: 5단계 진행형 시스템
  - **상품 준비중 버튼**: "주문 완료" → "상품 준비중" (알림 발송 안함)
  - **배송 준비중 버튼**: "상품 준비중" → "배송 준비중" (알림 발송 안함)
  - **배송 출발 버튼**: "배송 준비중" → "배송 출발" (알림 발송 안함)
  - **배송 완료 버튼**: "배송 출발" → "배송 완료" + **고객 알림 발송**
  - 상태 변경이 즉시 스프레드시트에 반영

### 4. QR 코드 시스템 (JWT 기반 + 본인 인증)
- **JWT 기반 QR 생성**: 
  - 각 배송담당자별로 JWT 토큰 기반 QR코드 생성
  - QR코드 내용: `/delivery/:date/:staffName?token=JWT_TOKEN`
  - 날짜와 배송담당자명이 URL에 포함
- **2단계 인증 시스템**:
  1. **1단계**: QR코드 스캔으로 초기 접근 (JWT 토큰 검증)
  2. **2단계**: 본인 이름 입력으로 최종 인증
- **이름 확인 프로세스**:
  - "본인 이름을 입력하세요" 입력 필드 표시
  - 입력값과 URL의 staffName 파라미터 정확히 일치해야 접근 허용
  - 대소문자, 띄어쓰기 정확히 일치 검증
  - 한국어 이름 2-4자 패턴 검증 (`/^[가-힣]{2,4}$/`)
- **접근 제어 로직**:
  - 이름 불일치 시: "이름이 일치하지 않습니다. 다시 확인해주세요." 메시지
  - 토큰 만료 시: 자동 재인증 요구
- **보안 토큰**: 
  - JWT 토큰 with SHA256 해시로 URL 위변조 방지
  - 24시간 만료 정책으로 보안 강화
  - 토큰 = JWT(staffName + date + secret + expiry)

### 5. SOLAPI OAuth2 연동 관리 UI
- **SOLAPI OAuth2 인증 인터페이스**:
  - "SOLAPI로 로그인" 버튼으로 OAuth2 연동 시작
  - 사용자가 SOLAPI 로그인 페이지로 리다이렉트
  - 권한 승인 페이지에서 사용자가 직접 권한 허용
- **OAuth2 권한 요청**:
  - 메시지 발송 권한 (message:write)
  - 잔액 조회 권한 (cash:read)
  - 발신번호 조회 권한 (senderid:read)
  - 템플릿 관리 권한 (kakao:write, kakao:read)
- **자동 연동 프로세스**:
  - OAuth2 승인 후 자동으로 Access Token 발급
  - 발신번호 목록 자동 조회 및 선택 UI 제공
  - 계정 정보 및 잔액 정보 자동 표시
- **연동 상태 모니터링**:
  - SOLAPI 연결 상태 (연결됨/연결 끊김) 실시간 표시
  - 발송 가능 건수 및 잔액 정보 표시
  - Access Token 만료 시 자동 갱신 또는 재인증 안내
- **템플릿 관리 시스템**:
  - OAuth2 연동 후 템플릿 목록 자동 조회
  - "배송 완료" 템플릿 선택 또는 신규 등록
  - 템플릿 승인 상태 실시간 추적 (대기/승인/반려)
  - 변수 치환 미리보기 제공 (#{고객명} 등)

### 6. SOLAPI를 통한 카카오톡 메시지 발송 (배송 완료시만)
- **SOLAPI HTTP API 연동**: OAuth2 기반 직접 HTTP API 호출 (SDK 미사용)
- **발송 시점**: 
  - **배송 완료 버튼 클릭시에만** 고객에게 메시지 발송
  - 상품 준비중, 배송 준비중, 배송 출발 상태는 알림 발송하지 않음
- **메시지 템플릿**: 
  - **배송 완료**: "#{고객명}님, 주문하신 상품이 성공적으로 배송 완료되었습니다. 맛있게 드세요!"
- **개인화 변수**: 
  - #{고객명} 등 기본 정보만 활용
  - 동적 헤더 시스템으로 다양한 고객 정보 필드 지원
- **발송 결과 처리**: 
  - 성공 시: "고객에게 완료 알림 발송됨" 메시지 표시
  - 실패 시: "메시지 발송 실패" 알림 및 재발송 버튼 제공
- **토큰 관리**: 
  - Access Token 자동 갱신
  - OAuth2 재인증 플로우 지원

### 7. 데이터 관리 (스프레드시트 중심)
- **메인 데이터 저장**: 모든 주문 데이터는 구글 스프레드시트에 저장
- **토큰 관리**: 
  - QR 토큰: JWT 기반 stateless 토큰
  - OAuth2 토큰: 세션 스토리지 또는 메모리 저장
- **로그 관리**: 
  - 메시지 발송 로그: 파일 기반 로깅 (winston)
  - 시스템 로그: console 및 파일 출력
- **백업**: 구글 스프레드시트 자체가 클라우드 백업

## S/W 개발 환경 및 기술 스택

### 백엔드 (Hono + Cloudflare Workers)
- **프레임워크**: Hono 4.x (Cloudflare Workers 호환)
- **언어**: TypeScript 5.x
- **런타임**: Cloudflare Workers (Edge Runtime)
- **저장소**: Cloudflare KV (세션), Google Sheets (메인 데이터)
- **주요 라이브러리**:
  ```json
  {
    "hono": "^4.x.x",
    "googleapis": "^100.0.0",
    "qrcode": "^1.5.0",
    "jsonwebtoken": "^9.0.0",
    "@cloudflare/workers-types": "^4.x.x"
  }
  ```

### 프론트엔드 (Vue.js)
- **프레임워크**: Vue 3 (Composition API)
- **빌드 툴**: Vite
- **상태 관리**: Pinia
- **라우팅**: Vue Router 4
- **UI 프레임워크**: 
  - Vuetify 3 (Material Design)
  - 또는 Tailwind CSS + Headless UI
- **주요 라이브러리**:
  ```json
  {
    "vue": "^3.3.0",
    "vue-router": "^4.2.0",
    "pinia": "^2.1.0",
    "axios": "^1.4.0",
    "vuetify": "^3.3.0"
  }
  ```
- **PWA**: Vue CLI PWA 플러그인

### 개발 도구 및 환경
- **패키지 매니저**: npm 또는 yarn
- **코드 포매터**: Prettier
- **린터**: ESLint
- **버전 관리**: Git
- **배포**: 
  - 백엔드: Cloudflare Workers (Edge deployment)
  - 프론트엔드: Cloudflare Pages (Static hosting)
- **환경 변수 관리**: .env 파일

## 기술적 요구사항 (MVP)

### 1. 시스템 아키텍처 (Hono + Vue.js + Cloudflare)
- **백엔드**: Hono/Cloudflare Workers 기반 Edge API 서버
  - SOLAPI HTTP API 직접 연동 (SDK 미사용)
  - Google Sheets API 연동
  - OAuth2 인증 처리 (Google + SOLAPI)
  - RESTful API 제공
  - Cloudflare KV 기반 세션 관리
- **프론트엔드**: Vue.js 3 기반 SPA (Cloudflare Pages)
  - **AdminView**: 관리자 설정 및 날짜별 데이터 관리
  - **StaffMobileView**: 모바일 최적화된 배송 관리 인터페이스
  - **DeliveryAuthView**: QR 인증 플로우
  - Vue Router를 통한 SPA 라우팅
  - Pinia를 통한 상태 관리
- **데이터 저장**: 
  - **메인 데이터**: 구글 스프레드시트 (날짜별)
  - **세션 관리**: Cloudflare KV
  - **토큰 관리**: JWT (QR 인증), OAuth2 (API 접근)
- **API 구조**: 
  ```
  /api/auth                    - OAuth2 인증 관련
  /api/sheets/date/:date       - 날짜별 스프레드시트 관리
  /api/sheets/date/:date/by-staff - 담당자별 그룹화 데이터
  /api/solapi                  - SOLAPI 연동 및 메시지 발송
  /api/delivery/qr             - QR 토큰 생성 및 검증
  ```

### 2. 구글 스프레드시트 연동 (Hono Backend)
- **백엔드 Google Sheets 처리**:
  - Cloudflare Workers에서 Google Sheets API v4 사용
  - Google OAuth2 클라이언트 라이브러리 활용
  - 동적 헤더 시스템으로 유연한 데이터 구조 지원
  - 날짜별 스프레드시트 자동 탐지
- **API 엔드포인트**:
  ```
  GET  /api/auth/google           - Google OAuth2 시작
  GET  /api/auth/google/callback  - OAuth2 콜백 처리
  GET  /api/auth/status           - 인증 상태 확인
  GET  /api/sheets/spreadsheets   - 스프레드시트 목록 조회
  GET  /api/sheets/date/:date     - 날짜별 데이터 조회 (YYYYMMDD)
  GET  /api/sheets/date/:date/by-staff - 담당자별 그룹화 데이터
  PUT  /api/sheets/data/:date/status   - 배송 상태 업데이트
  ```
- **Vue.js 프론트엔드**:
  - 구글 로그인 버튼으로 OAuth2 시작
  - 스프레드시트 선택 드롭다운 컴포넌트
  - 실시간 동기화 상태 표시 컴포넌트
- **실시간 동기화**: 
  - 폴링 방식으로 시트 변경사항 감지
  - WebSocket 또는 Server-Sent Events 활용 가능

### 3. QR 코드 시스템 (Hono + Vue.js)
- **백엔드 QR 처리**:
  - Cloudflare Workers에서 qrcode 라이브러리 사용
  - JWT 토큰 기반 QR 코드 생성 및 검증
  - 날짜 + 배송담당자명 기반 고유 URL 생성
  - 24시간 만료 정책으로 보안 강화
- **API 엔드포인트**:
  ```
  POST /api/delivery/qr/generate   - 배송자별 QR 코드 생성
  GET  /api/delivery/qr/verify     - QR JWT 토큰 검증
  POST /api/delivery/auth          - 배송자 이름 확인 인증
  GET  /api/delivery/:date/:staff  - 날짜별 배송자 주문 목록
  PUT  /api/sheets/data/:date/status - 배송 상태 업데이트
  ```
- **Vue.js 프론트엔드**:
  - **관리자용**: QR 코드 생성 및 다운로드 컴포넌트

- **모바일 최적화**: 
  - Vue.js PWA 설정으로 모바일 앱처럼 사용
  - 터치 친화적인 UI 컴포넌트

### 4. SOLAPI OAuth2 연동 (Hono Backend)
- **백엔드 SOLAPI 처리**:
  - Cloudflare Workers에서 SOLAPI HTTP API 직접 호출 (SDK 미사용)
  - OAuth2 Authorization Code 처리
  - Access Token 및 Refresh Token을 Cloudflare KV에 저장
  - 메시지 발송 HTTP API 직접 호출
- **프론트엔드 Vue.js 연동**:
  - Vue.js에서 백엔드 API 호출
  - OAuth2 인증 플로우 처리
  - 실시간 연동 상태 표시
- **API 엔드포인트**:
  ```
  GET  /api/solapi/auth/login     - SOLAPI OAuth2 시작
  GET  /api/solapi/auth/callback  - OAuth2 콜백 처리  
  GET  /api/solapi/account        - 계정 정보 조회
  GET  /api/solapi/senders        - 발신번호 목록 조회
  POST /api/solapi/send           - 메시지 발송
  GET  /api/solapi/templates      - 템플릿 목록 조회
  ```
- **토큰 관리**:
  - Cloudflare KV에서 Access Token 안전하게 저장
  - 토큰 만료 시 자동 갱신 처리
  - 프론트엔드는 세션 기반 인증 상태만 확인

## 성능 요구사항 (MVP)
- **스프레드시트 동기화**: 30개 주문 기준 10초 이내 동기화
- **QR 코드 스캔**: 스캔 후 5초 이내 페이지 로딩
- **메시지 발송**: 배송 완료 버튼 클릭 후 3초 이내 고객에게 메시지 발송
- **동시 접속**: 최대 10명의 배송담당자 동시 접속

## 보안 요구사항
- **QR 코드 보안**: 시트명 기반 해시 토큰으로 무단 접근 방지
- **본인 인증**: 이름 확인을 통한 2단계 인증
- **OAuth2 토큰 보안**: SOLAPI 및 Google OAuth2 토큰 안전한 저장
- **개인정보 보호**: 고객 연락처 정보 적절한 처리
- **접근 제어**: 각 배송담당자는 자신의 시트만 접근 가능

## 시스템 흐름도 (MVP)

### 1. 관리자 워크플로우 (OAuth2 기반 설정)
1. **관리자 설정 페이지 접속** (AdminView)
2. **"구글 스프레드시트 연결하기" 버튼 클릭**
3. **Google 계정 OAuth 인증 진행**
4. **날짜별 스프레드시트 자동 탐지 및 연결**
5. **"SOLAPI로 로그인" 버튼 클릭**
6. **SOLAPI 로그인 페이지에서 사용자 인증**
7. **권한 승인 페이지에서 메시지 발송 권한 허용**
8. **OAuth2 연동 완료 후 발신번호 및 템플릿 자동 설정**
9. **날짜별 스프레드시트에 배송 정보 입력**: 배송지, 고객명, 연락처, 배송담당자
10. **달력에서 날짜 선택하여 해당일 주문 데이터 확인**
11. **배송담당자별로 QR코드 자동 생성 및 제공**

### 2. 배송담당자 워크플로우 (2단계 인증)
1. 자신의 QR 코드 스캔으로 웹사이트 접속 (`/delivery/:date/:staffName`)
2. **JWT 토큰 자동 검증** (24시간 만료, 위변조 방지)
3. **본인 이름 입력하여 인증** (staffName 파라미터와 일치 확인)
4. 인증 성공 후 해당 날짜의 자신 담당 배송 목록 확인 (StaffMobileView)
5. 각 주문별로 5단계 상태 변경: 주문완료 → 상품준비중 → 배송준비중 → 배송출발 → 배송완료
6. **배송 완료시에만** 고객에게 SOLAPI 카카오톡 알림 발송
7. 변경사항이 Google Sheets 배송상태 컬럼에 실시간 반영

## 사용자 경험 요구사항 (MVP)

### 1. 관리자 경험 (통합 설정 UI)
- **간편한 연동 과정**: "구글 스프레드시트 연결하기" 버튼으로 쉬운 시작
- **직관적인 OAuth**: Google 계정 로그인과 동일한 친숙한 인증 과정
- **스프레드시트 선택**: 드롭다운에서 기존 시트 선택하거나 새로 생성
- **SOLAPI OAuth2 연동**:
  - "SOLAPI로 로그인" 버튼으로 OAuth2 인증 시작
  - 권한 승인 페이지에서 사용자가 직접 권한 허용
  - 연동 완료 후 계정 정보 및 발신번호 자동 설정
  - Access Token 자동 관리 및 갱신
- **자동 설정**: 배송담당자명 입력하면 시트 구조 자동 생성
- **실시간 모니터링**: 
  - 구글 시트 연동 상태
  - SOLAPI 연결 상태 및 잔액 정보
  - 메시지 발송 성공률 통계
- **QR코드 관리**: 생성된 QR코드 다운로드 및 인쇄 기능

### 2. 배송담당자 경험 (본인 인증 + 다중 주문 관리)
- **간편한 QR 접근**: QR 스캔으로 웹사이트 접근
- **직관적인 본인 인증**: "본인 이름을 입력하세요" 간단한 확인 절차
- **명확한 피드백**: 이름 불일치 시 친절한 오류 메시지 표시
- **전체 목록 확인**: 인증 후 자신에게 할당된 모든 배송 주문을 한 화면에서 확인
- **주문별 상태 관리**: 각 주문마다 독립적인 배송 상태 버튼
- **주소 정보 표시**: 배송 주소를 명확하게 표시
- **완료시 알림**: 배송 완료 버튼 클릭 시에만 고객에게 알림 발송
- **진행률 표시**: 전체 주문 중 완료된 주문 비율 표시

### 3. 알림 메시지 품질 (배송 완료시만)
- **단일 메시지**: 배송 완료시에만 발송하는 간단한 완료 알림
- **필수 정보**: 고객명, 배송 완료 확인 문구
- **정중한 톤**: "맛있게 드세요" 등 친근한 마무리 인사

## MVP 개발 우선순위

### Phase 1 (필수 기능)
1. **관리자 설정 페이지**: 스프레드시트 연동 UI
2. **Google OAuth 인증**: 사용자 친화적 연동 과정
3. **SOLAPI OAuth2 연동 UI**: 로그인 기반 권한 승인 인터페이스
4. 구글 스프레드시트 다중 시트 읽기/쓰기 기능
5. 배송자별 QR 코드 생성 및 접근 제어
6. **본인 이름 확인 인증 시스템**
7. 시트별 주문 목록 표시 웹사이트
8. SOLAPI 알림톡 발송 (배송 완료 1개 템플릿)

### Phase 2 (부가 기능)
1. 스프레드시트 자동 생성 기능
2. SOLAPI OAuth2 토큰 자동 갱신
3. 템플릿 승인 상태 자동 알림
4. 배송 진행률 표시
5. 메시지 발송 실패 재시도
6. QR코드 일괄 다운로드 기능

### 제외 기능 (추후 확장)
- 지도 및 위치 서비스
- 길찾기 앱 연동
- 배송 준비중/출발 단계 고객 알림
- 예상 도착시간 계산
- 관리자 전용 웹사이트
- SMS 대체 발송
- 실시간 위치 추적
- 복잡한 대시보드 및 통계
- 고급 보안 기능

## 운영 요구사항 (MVP)
- **기본 모니터링**: 시스템 가동 상태 확인
- **구글 시트 백업**: 스프레드시트 자체가 마스터 데이터
- **간단한 장애 대응**: 기본적인 에러 로깅 및 알림
- **확장 계획**: MVP 검증 후 추가 기능 개발

---
*문서 버전: 8.0 (Final MVP - Hono + Vue.js + Cloudflare)*
*최종 수정: 2025-08-28*