name = "deliver-mgmt-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# 빌드 시 BUILD_DATE 자동 업데이트 + 웹 빌드 (macOS/Linux 호환)
[build]
command = "if [ \"$(uname)\" = 'Darwin' ]; then sed -i '' \"s/BUILD_DATE = \\\".*\\\"/BUILD_DATE = \\\"$(date '+%y\\/%m\\/%d %H:%M')\\\"/\" wrangler.toml; else sed -i \"s/BUILD_DATE = \\\".*\\\"/BUILD_DATE = \\\"$(date '+%y\\/%m\\/%d %H:%M')\\\"/\" wrangler.toml; fi && cd web && npm install && npm run build"

# Static Assets (웹 페이지 서빙)
[assets]
directory = "./web/dist"
not_found_handling = "single-page-application"
run_worker_first = ["/api/*"]

[vars]
BUILD_DATE = "25/12/31 23:09"
RESEND_FROM_EMAIL = "noreply@try-dabble.com"
# Magic Link 베이스 URL
MAGIC_LINK_BASE_URL = "deliver-mgmt-worker.coreanq.workers.dev"
# 테스트 이메일 (프로덕션에서 비활성화: Cloudflare Dashboard에서 ""로 설정)
TEST_EMAILS = "dev@test.com,dev@example.com"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "deliver-mgmt-db"
database_id = "7cf87799-fd84-4327-bd49-8bdb58ce1542"

# R2 Storage (배송 사진)
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "deliver-mgmt-photos"

# KV Namespace (캐시)
[[kv_namespaces]]
binding = "KV-DELIVER-MGMT"
id = "96cd08ccdeba45e8a9d13286c9797767"

# Cron Triggers (데이터 정리 - 매일 새벽 3시 UTC)
[triggers]
crons = ["0 3 * * *"]

# ============================================
# 환경변수 (wrangler secret put <KEY>로 설정)
# ============================================
#
# 인증 관련
# wrangler secret put JWT_SECRET          # JWT 토큰 서명용 비밀키
# wrangler secret put RESEND_API_KEY      # Resend 이메일 API 키
#
# AI Gateway (Cloudflare AI Gateway + BYOK)
# wrangler secret put AI_GATEWAY_ACCOUNT_ID  # Cloudflare Account ID
# wrangler secret put AI_GATEWAY_NAME        # AI Gateway 이름
# wrangler secret put CF_AIG_TOKEN           # AI Provider API 키 (xAI/OpenAI/Anthropic)
#
# Coupang API
# wrangler secret put COUPANG_ACCESS_KEY  # 쿠팡 API Access Key
# wrangler secret put COUPANG_SECRET_KEY  # 쿠팡 API Secret Key
